# 停车场管理系统

## 前期准备

### 需求分析

#### 权限分析

#### 功能分析

1. 管理员
   1. 登录（用户名，密码）
   2. 系统设置：
      1. 设置最大免费时间
      2. 收费规则
      3. 设置免费车辆（车牌，车主，手机号）、查看所有的免费车辆并删除
      4. 开启或关闭停车场
      5. 设置年卡费用
   3. 公告管理：
      1. 发布公告
      2. 删除
   4. 车位管理：（id，车位名字，车位状态，状态描述）
      1. 添加
      2. 删除
      3. 修改
   5. 查看停车记录：
      1. 首页看到一个表格，显示今天所有的停车记录，倒序排列
      2. 点击某个链接查看所有记录
      3. 根据时间搜索记录，查那一天或者时间段之内.                                                           
   6. 查看收入：
      1. 年收入、月收入、当天收入
      2. 当前有多少个年卡
   7. 查看当前空余车位
   8. 年卡管理
2. 用户
   1. 停车（车牌，进入时间，取车时间，本次缴费多少，当前状态，停在哪个车位）
      1. 输入车牌进入
      2. 获得当前时间作为停车时间
      3. 到车位表里找一个空闲的车位分配给该车辆，当前车位状态改为已占用
   2. 取车
      1. 先输入车牌，后台根据车牌找到对应的记录
      2. 获得当前时间，减去停车时间，根据缴费规则计算费用
      3. 页面显示请交费
      4. 更新停车记录表，状态改为已结束，更新费用
      5. 车位表更新对应的车位状态
      6. 显示一路平安
   3. 办理年卡（车牌，车主，手机，缴费多少，办卡时间，到期时间/有效期）
      1. 车主信息
      2. 点击缴费，后台创建信息

#### 流程分析

## 设计

### 数据库设计

- 车辆记录表：停车记录信息
- 系统表：免费时间，收费规则，停车场状态
- 车位表
- 公告（标题，内容，发布时间）
- 收入表（id，收入，时间（2020-10-14 01:32），月份，年）
- 类型表（车牌，车主，手机，类型，有效期，办卡时间，截止日期）

### 框架设计

​		Mybatis 	SpringBoot  MysqlDiver   Thymeleaf 



### 页面设计

## 项目编写

### 创建项目（IDEA）

​	Mybatis 	SpringBoot  MysqlDiver   Thymeleaf 

#### 导入额外需要的jar包

- log4j-1.2.16.jar  

- mybatis-generator-core-1.3.2.jar  

- mysql-connector-java-5.1.7-bin.jar  

- ojdbc14.jar

### 配置文件

#### 配置application.yml文件

将 application.perporties后缀改为application.yml

```yml
Spring:
  dataSource:
    name: xsh  #数据库名
    url: jdbc:mysql://localhost:3306/parking?characterEncoding=UTF-8&serverTimezone=CST #URL
    username: root #用户名
    password: Logan #密码
    driver-class-name: com.mysql.cj.jdbc.Driver #mysql驱动

    mybatis:
      typeAliasesPackage: com.parking.pojo #生成实体类的位置
      mapperLocations: classpath:mappers/*.xml 
      pagehelper:
        helper-dialect: mysql
        reasonable: true
        support-methods-arguments: true
    mvc: #mvc 视图
      view:
        prefix: /templates/
        suffix: .html
server: #端口
  port: 8080
  
```

### 自动生成pojo和mapper

**利用mybatis的逆向工程生成pojo和mapper**

##### 将log4j.properties放在resources目录下

```properties
log4j.rootLogger=DEBUG, Console
#Console
log4j.appender.Console=org.apache.log4j.ConsoleAppender
log4j.appender.Console.layout=org.apache.log4j.PatternLayout
log4j.appender.Console.layout.ConversionPattern=%d [%t] %-5p [%c] - %m%n
log4j.logger.java.sql.ResultSet=INFO
log4j.logger.org.apache=INFO
log4j.logger.java.sql.Connection=DEBUG
log4j.logger.java.sql.Statement=DEBUG
log4j.logger.java.sql.PreparedStatement=DEBUG
```

##### 将generatorConfig.xml放在项目根目录下进行配置

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration
  PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"
  "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">

<generatorConfiguration>
	<context id="parkTables" targetRuntime="MyBatis3">
		<commentGenerator>
			<!-- 是否去除自动生成的注释 true：是 ： false:否 -->
			<property name="suppressAllComments" value="true" />
		</commentGenerator>
		<!--数据库连接的信息：驱动类、连接地址、用户名、密码 -->

		<jdbcConnection driverClass="com.mysql.cj.jdbc.Driver"
			connectionURL="jdbc:mysql://localhost:3306/parking?characterEncoding=utf-8
" userId="root"
			password="root">
		</jdbcConnection>
		<!-- <jdbcConnection driverClass="oracle.jdbc.OracleDriver"
			connectionURL="jdbc:oracle:thin:@127.0.0.1:1521:yycg" 
			userId="yycg"
			password="yycg">
		</jdbcConnection> -->

		<!-- 默认false，把JDBC DECIMAL 和 NUMERIC 类型解析为 Integer，为 true时把JDBC DECIMAL 和 
			NUMERIC 类型解析为java.math.BigDecimal -->
		<javaTypeResolver>
			<property name="forceBigDecimals" value="false" />
		</javaTypeResolver>

		<!-- targetProject:生成PO类的位置 -->
		<javaModelGenerator targetPackage="com.parking.pojo"
			targetProject="./src/main/java">
			<!-- enableSubPackages:是否让schema作为包的后缀 -->
			<property name="enableSubPackages" value="false" />
			<!-- 从数据库返回的值被清理前后的空格 -->
			<property name="trimStrings" value="true" />
		</javaModelGenerator>
        <!-- targetProject:mapper映射文件生成的位置 -->
		<sqlMapGenerator targetPackage="com.parking.mapper"
			targetProject="./src/main/java">
			<!-- enableSubPackages:是否让schema作为包的后缀 -->
			<property name="enableSubPackages" value="false" />
		</sqlMapGenerator>
		<!-- targetPackage：mapper接口生成的位置 -->
		<javaClientGenerator type="XMLMAPPER"
			targetPackage="com.parking.mapper"
			targetProject="./src/main/java">
			<!-- enableSubPackages:是否让schema作为包的后缀 -->
			<property name="enableSubPackages" value="false" />
		</javaClientGenerator>
    
    
		<!-- 指定需要生成jopo和mapper的表 -->
		<table schema="" tableName="notice"></table>
		<table schema="" tableName="parking"></table>
		<table schema="" tableName="cardForm"></table>
		<table schema="" tableName="carRecord"></table>
		<table schema="" tableName="income"></table>
		<table schema="" tableName="rule"></table>		
		<!-- 有些表的字段需要指定java类型
		 <table schema="" tableName="user">
			<columnOverride column="id" javaType="Long" />
		</table> -->
	</context>
</generatorConfiguration>

```

**注意：Mac和Windows路径的配置不一样**

**Mac targetProject=”./src/main/java“**

**windows targetProject=”.\src“**

##### 将GeneratorSqlmap.java放在src/main/java目录下

```java
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.mybatis.generator.api.MyBatisGenerator;
import org.mybatis.generator.config.Configuration;
import org.mybatis.generator.config.xml.ConfigurationParser;
import org.mybatis.generator.exception.XMLParserException;
import org.mybatis.generator.internal.DefaultShellCallback;

public class GeneratorSqlmap {

	public void generator() throws Exception{

		List<String> warnings = new ArrayList<String>();
		boolean overwrite = true;
		//指定 逆向工程配置文件
		File configFile = new File("generatorConfig.xml"); 
		ConfigurationParser cp = new ConfigurationParser(warnings);
		Configuration config = cp.parseConfiguration(configFile);
		DefaultShellCallback callback = new DefaultShellCallback(overwrite);
		MyBatisGenerator myBatisGenerator = new MyBatisGenerator(config,
				callback, warnings);
		myBatisGenerator.generate(null);

	} 
	public static void main(String[] args) throws Exception {
		try {
			GeneratorSqlmap generatorSqlmap = new GeneratorSqlmap();
			generatorSqlmap.generator();
		} catch (Exception e) {
			e.printStackTrace();
		}
		
	}

}
```

##### 直接运行GeneratorSqlmap.java

在resources目录下依次创建com 、parking、mapper包，然后将生成的mapper.xml文件放在mapper包下



## 问题总结

### 关于text类型的问题

```html
<div class="panel panel-primary"th:each="notice: ${list}">
    <div class="panel-heading" th:text="${notice.title}"></div>
    <div class="panel-content" th:text="${notice.content}"></div>
</div>
```

使用th标签循环内容，显示不出来，控制台也不报错。。。。。

解决思路：

​	首先我看了下是否是div的问题，将div更换为p标签显示，结果还是输出不出来

​	在controller页面循环输出notice对象结果如下

```java
1	null	null
2	null	null
3	null	null
```

然后看了下Notice类，发现title和content属性是String类型，而数据库里是text类型

考虑到pojo和mapper都是mybatis逆向生成的，然后查看了mapper提供的接口，发现如下

```java
List<Notice> selectByExampleWithBLOBs(NoticeExample example);

List<Notice> selectByExample(NoticeExample example);

Notice selectByPrimaryKey(Integer id);
```

看了一下他们的api

两个方法的返回的resultMap 不同

selectByExample 方法返回：BaseResultMap

selectByExampleWithBLOBs 方法返回：ResultMapWithBLOBs

**selectByExample的resultMap:**

```java
<resultMap id="BaseResultMap" type="cn.e3mall.pojo.TbItemDesc">
    <id column="item_id" jdbcType="BIGINT" property="itemId" />
    <result column="created" jdbcType="TIMESTAMP" property="created" />
    <result column="updated" jdbcType="TIMESTAMP" property="updated" />
  </resultMap>
```

**selectByExampleWithBLOBs的resultMap:**

```java
<resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="cn.e3mall.pojo.TbItemDesc">
 			<result column="item_desc" jdbcType="LONGVARCHAR" property="itemDesc" />
</resultMap>
```

ResultMapWithBLOBs继承了BaseResultMap，不仅有了BaseResultMap中的属性，同时也有了自己的paramData属性。该属性是longvarchar类型

所以检索大字段时，则需要使用selectByExampleWithBLOBs ，一般情况则使用selectByExample 

**总结：**

**如果我们要在数据库中查询的结果集中，包含text类型的字段，一定要用selectByExampleWithBLOBs，否则会查不到对应字段的结果集。**

### 关于端口占用

用idea运行了一个web项目后，不知道为什么，关掉idea后这个项目依然可以运行，

解决方法：

打开终端

`losf -i:8080`

结果如下：

```java
COMMAND PID USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
java    665 snow  153u  IPv6 0xc32382e42aa8fdd1      0t0  TCP *:http-alt (LISTEN)

```

执行

`kill -9 665`

成功关闭端口

### 关于Mac maven配置环境变量

编辑.bash_profile文件：

```
vim ~/.bash_profile
```

按i 进行编辑

配置maven文件地址：

```
MAVEN_HOME=/Users/JYH/Desktop/Hadoop-2.7.2/apache-maven-3.3.9   //maven解压目录
PATH=$MAVEN_HOME/bin:$PATH
export MAVEN_HOME 
export PATH
export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_40.jdk/Contents/Home /
```

按  :wq! 保存并退出

保存文件，执行如下命令使配置生效：

```
source ~/.bash_profile
```

#### 验证

输入：

```
mvn -v
```

打开idear 主页面

点击preferences 搜索maven 

进入maven设置页面

Maven home directory  设置已下载好的maven地址

User settings file  设置本地的setting文件

Local repository	设置本地的仓库

### Mybatis  问题

```java
org.apache.ibatis.exceptions.PersistenceException: 
### Error querying database.  Cause: org.apache.ibatis.executor.ExecutorException: No constructor found in pojo.TestUser matching [java.lang.Integer, java.lang.String, java.lang.Integer]
### The error may exist in mapper/TestUser.xml
### The error may involve xxx.findAll
### The error occurred while handling results
### SQL: select * from test_user
```

TestUser没有空的构造，不能完成初始化TestUser

### 关于idea 中使用mybastis报出 Invalid bound statement (not found)的错误解决方案

```xml
   <mapper resource="com/mapper/TestUserMapper.xml"></mapper>-->
```

mapper这样定义可以正常运行

```xml
mappers>
<!--        <mapper resource="com/mapper/TestUserMapper.xml"></mapper>-->
        <package name="mapper"/>
    </mappers>
```

换成 <package name="mapper">报错

解决:

因为sesource指定的是xml的全路径，mybatis可以映射到。

而定义成包名，则需要接口名和映射文件名一模一样，否则映射不到

**接口名与Mybatis的映射文件名一定要一模一样。**